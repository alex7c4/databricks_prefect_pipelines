services:

  # Prefect Agent
  agent:
    image: prefecthq/prefect:2-python3.11
    restart: always
    entrypoint: [
      "/usr/bin/bash", "-c",
      "/opt/prefect/entrypoint.sh &&
      prefect cloud login --key ${PREFECT_API_KEY} --workspace ${PREFECT_WORKSPACE} &&
      prefect agent start --pool default-agent-pool --work-queue default",
    ]
    environment:
      EXTRA_PIP_PACKAGES: s3fs
      # PREFECT_API_KEY -- not working for cloud connection (bug?)

  # Prefect CLI
  cli:
    image: prefecthq/prefect:2-python3.11
    tty: true  # keep running
    working_dir: "/root/flows"
    volumes:
      - "./src/flows:/root/flows"
    environment:
      EXTRA_PIP_PACKAGES: s3fs

  # MinIO for flow storage
  minio:
    image: minio/minio:latest
    command: minio server /data
    environment:
      MINIO_ROOT_USER: rootuser
      MINIO_ROOT_PASSWORD: password123
      MINIO_ADDRESS: ":9000"
      MINIO_CONSOLE_ADDRESS: ":9090"
    volumes:
      - "minio:/data"
    ports:
      - 9000:9000
      - 9090:9090

volumes:
  minio:

networks:
  default:
    name: prefect-network
